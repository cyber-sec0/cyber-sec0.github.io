<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Website Monitor Settings</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
				background-color: #121212;
				color: #e0e0e0;
				margin: 0;
				padding: 2rem;
			}
			.container {
				max-width: 800px;
				margin: 0 auto;
			}
			h2,
			h3,
			h4 {
				color: #bb86fc;
				border-bottom: 2px solid #373737;
				padding-bottom: 0.5rem;
			}
			h4 {
				border-bottom: none;
				margin-bottom: 0.5rem;
			}
			.header-with-button {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.form-group {
				margin-top: 1rem;
				margin-bottom: 1.5rem;
				padding: 1.5rem;
				background-color: #1e1e1e;
				border-radius: 8px;
				border: 1px solid #333;
			}
			label {
				display: block;
				margin-bottom: 0.5rem;
				color: #a0a0a0;
			}
			.label-with-icon {
				display: flex;
				align-items: center;
				gap: 8px;
			}
			.label-with-icon > label {
				margin-bottom: 0;
				cursor: pointer;
			}
			.help-icon {
				cursor: help;
				font-style: normal;
				font-weight: 700;
				display: inline-block;
				border-radius: 50%;
				width: 1.2em;
				height: 1.2em;
				text-align: center;
				line-height: 1.2em;
				background-color: #555;
				font-size: 0.8em;
			}
			input,
			textarea,
			select {
				width: 100%;
				background-color: #2c2c2c;
				color: #e0e0e0;
				border: 1px solid #444;
				border-radius: 4px;
				padding: 0.75rem;
				font-family: 'Courier New', Courier, monospace;
				font-size: 14px;
				margin-bottom: 1rem;
			}
			.interval-group {
				display: flex;
				gap: 20px;
				align-items: center;
			}
			.interval-group > div {
				display: flex;
				flex-direction: column;
			}
			.interval-group input[type='number'] {
				width: 100px;
				margin-top: 8px;
			}
			input:read-only {
				background-color: #404040;
			}
			.hidden {
				display: none;
			}
			textarea {
				min-height: 100px;
				resize: vertical;
			}
			.button-group {
				display: flex;
				gap: 10px;
			}
			button {
				background-color: #bb86fc;
				color: #121212;
				font-weight: 700;
				border: none;
				border-radius: 4px;
				padding: 0.75rem 1.5rem;
				cursor: pointer;
				transition: background-color 0.2s;
			}
			ul {
				list-style: none;
				padding: 0;
			}
			li {
				background-color: #1e1e1e;
				border: 1px solid #333;
				border-radius: 4px;
				padding: 1rem;
				margin-top: 1rem;
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				transition: opacity 0.3s;
			}
			.entry-details {
				word-break: break-all;
				flex-grow: 1;
			}
			.entry-details strong {
				font-size: 1.1em;
			}
			.entry-details small {
				display: block;
				color: #a0a0a0;
				margin-top: 4px;
			}
			.entry-details .detail-label {
				color: #888;
				font-weight: 700;
			}
			.entry-actions {
				display: flex;
				gap: 4px;
				margin-left: 1rem;
			}
			.action-btn {
				background: 0 0;
				border: none;
				font-size: 1.2rem;
				cursor: pointer;
				color: #a0a0a0;
				padding: 2px 4px;
				border-radius: 4px;
			}
			.action-btn:hover {
				background-color: #333;
			}
			.help-text {
				font-size: 12px;
				color: #888;
				margin-top: -1rem;
				margin-bottom: 1rem;
				padding: 0.5rem;
				background-color: #222;
				border-radius: 4px;
			}
			#toggleFormBtn {
				font-size: 1.5rem;
				width: 40px;
				height: 40px;
				padding: 0;
				line-height: 40px;
				text-align: center;
			}
			details summary {
				cursor: pointer;
				font-size: 1.2em;
				font-weight: 700;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h2>Website Monitor</h2>
			<h4>GLOBAL SETTINGS</h4>
			<div class="form-group">
				<div class="interval-group">
					<div>
						<label for="hours" class="label-with-icon"><span>Hours</span><span class="help-icon" title="Set hours between checks">?</span></label
						><input type="number" id="hours" min="0" />
					</div>
					<div>
						<label for="minutes" class="label-with-icon"><span>Minutes</span><span class="help-icon" title="Set minutes between checks">?</span></label
						><input type="number" id="minutes" min="0" />
					</div>
				</div>
				<button id="save">Save</button>
			</div>
			<div class="header-with-button">
				<h3>ADD</h3>
				<button id="toggleFormBtn" title="Add new">+</button>
			</div>
			<div id="form" class="form-group hidden">
				<h3 id="title">Add New Site</h3>
				<label class="label-with-icon"><span>Name</span><span class="help-icon" title="Nickname for reference">?</span></label
				><input type="text" id="name" /> <label class="label-with-icon"><span>Endpoint URL</span><span class="help-icon" title="URL to check">?</span></label
				><input type="text" id="url" /> <label class="label-with-icon"><span>Open URL (Optional)</span><span class="help-icon" title="URL to open on change">?</span></label
				><input type="text" id="openUrl" />
				<label class="label-with-icon"><span>Comparison Method</span><span class="help-icon" title="How to detect changes">?</span></label>
				<select id="method">
					<option value="text">Text</option>
					<option value="order">Order</option>
					<option value="new_items">New Items</option>
				</select>
				<div id="list" class="hidden">
					<label class="label-with-icon"><span>Selector</span><span class="help-icon" title="CSS selector for list items">?</span></label
					><input type="text" id="selector" /> <label class="label-with-icon"><span>ID Attribute</span><span class="help-icon" title="Unique attribute">?</span></label
					><input type="text" id="attr" />
				</div>
				<label><input type="checkbox" id="tokenEn" />Enable Token<span class="help-icon" title="Dynamic tokens">?</span></label>
				<div id="token" class="hidden">
					<label class="label-with-icon"><span>Token URL</span><span class="help-icon" title="Where to fetch token">?</span></label
					><input type="text" id="tokenUrl" /> <label class="label-with-icon"><span>Token Selector</span><span class="help-icon" title="CSS selector">?</span></label
					><input type="text" id="tokenSel" /> <label class="label-with-icon"><span>RegEx (Optional)</span><span class="help-icon" title="Extract token">?</span></label
					><input type="text" id="tokenRe" /> <label class="label-with-icon"><span>Attribute (Optional)</span><span class="help-icon" title="Element attribute">?</span></label
					><input type="text" id="tokenAttr" /> <label class="label-with-icon"><span>Placeholder</span><span class="help-icon" title="e.g. %%NONCE%%">?</span></label
					><input type="text" id="tokenPh" />
				</div>
				<label class="label-with-icon"><span>Headers (JSON)</span><span class="help-icon" title="Request headers">?</span></label
				><textarea id="hdrs"></textarea> <label class="label-with-icon"><span>Body</span><span class="help-icon" title="POST data">?</span></label
				><textarea id="body"></textarea>
				<div class="button-group"><button id="add">Add Site</button></div>
			</div>
			<h3>Monitored Sites</h3>
			<ul id="listActive"></ul>
			<div id="pausedSection">
				<details>
					<summary>Paused Sites</summary>
					<ul id="listPaused"></ul>
				</details>
			</div>
		</div>
		<script>
			const save = document.getElementById('save'),
				hInput = document.getElementById('hours'),
				mInput = document.getElementById('minutes'); //cache inputs
			(() => {
				const load = () => {
					const ms = GM_getValue('check_interval_ms', 60000),
						h = Math.floor(ms / 3600000),
						m = Math.floor((ms % 3600000) / 60000);
					hInput.value = h;
					mInput.value = m;
				}; //load saved
				save.addEventListener('click', () => {
					const h = +hInput.value || 0,
						m = +mInput.value || 0,
						tot = h * 3600000 + m * 60000;
					if (tot >= 60000) {
						GM_setValue('check_interval_ms', tot);
						alert('Saved');
					} else alert('Min 1 minute');
				});
			})();
			(() => {
				const toggleForm = document.getElementById('toggleFormBtn'),
					form = document.getElementById('form');
				toggleForm.addEventListener('click', () => {
					form.classList.toggle('hidden');
					toggleForm.textContent = form.classList.contains('hidden') ? '+' : '-';
					reset();
				});
				const method = document.getElementById('method'),
					list = document.getElementById('list');
				method.addEventListener('change', () => {
					list.classList.toggle('hidden', !['order', 'new_items'].includes(method.value));
				});
				const tokenEn = document.getElementById('tokenEn'),
					token = document.getElementById('token');
				tokenEn.addEventListener('change', () => {
					token.classList.toggle('hidden', !tokenEn.checked);
				});
				const reset = () => {
					document.getElementById('name').value = '';
					document.getElementById('url').value = '';
					document.getElementById('openUrl').value = '';
					method.value = 'text';
					list.classList.add('hidden');
					tokenEn.checked = false;
					token.classList.add('hidden');
					document.getElementById('hdrs').value = '';
					document.getElementById('body').value = '';
				}; //clear form
				const loadSites = () => {
					//render sites
					document.getElementById('listActive').innerHTML = '';
					document.getElementById('listPaused').innerHTML = '';
					document.getElementById('pausedSection').style.display = 'none';
					GM_listValues().forEach((key) => {
						if (/^Number$|^check_interval_ms$|^lock_/.test(key)) return;
						const d = GM_getValue(key, {}),
							url = key.replace(/Counter\d+/, '');
						const li = document.createElement('li'),
							paused = d.isPaused;
						let html = `<strong>${d.name || url}</strong><small>Endpoint:${url}</small>`;
						if (d.website && d.website !== url) html += `<small>Opens:${d.website}</small>`;
						if (d.comparisonMethod) html += `<small>Method:${d.comparisonMethod.replace(/_/g, ' ')}</small>`;
						li.innerHTML = `<div class="entry-details">${html}</div><div class="entry-actions"><button class="action-btn pause-btn" title="${paused ? 'Resume' : 'Pause'}">${paused ? '▶️' : '⏸️'}</button><button class="action-btn delete-btn" title="Delete">❌</button></div>`;
						li.querySelector('.pause-btn').addEventListener('click', () => {
							const cur = GM_getValue(key, {});
							cur.isPaused = !cur.isPaused;
							GM_setValue(key, cur);
							loadSites();
						});
						li.querySelector('.delete-btn').addEventListener('click', () => {
							if (confirm('Stop monitoring?')) GM_deleteValue(key), loadSites();
						});
						if (paused) {
							document.getElementById('listPaused').appendChild(li);
							document.getElementById('pausedSection').style.display = 'block';
						} else document.getElementById('listActive').appendChild(li);
					});
				};
				const saveGlobal = () => {
					loadSites();
					loadGlobal();
				}; //initial
			})();
		</script>
	</body>
</html>
